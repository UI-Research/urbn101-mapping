---
title: "Day 3: Spatial Operations"
author: "Sarah Strochak"
date: "`r format(Sys.time(), '%B %d, %Y %H:%M')`"
output:
  html_document:
    number_sections: FALSE
    self_contained: TRUE
    code_folding: show
    toc: TRUE
    toc_float: TRUE
    css: ../www/web_report.css
    editor_options:
      chunk_output_type: console
---

  

<style>
@import url('https://fonts.googleapis.com/css?family=Lato&display=swap');
</style>

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato" />

![](../www/images/urban-institute-logo.png)


```{r rmarkdown-setup, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
```


# Review 

* Use GeoJSON's whenever possible!
* Use `st_read()` and `st_write()` to read/write out spatial files
* Be careful about Coordinate Reference Systems!
* Use the `tigris` and `tidycensus` packages to easily obtain spatial data

```{r, warning=F, message=F, eval = T}
library(tidyverse)
library(sf)
library(urbnmapr)
library(urbnthemes)
library(tigris)
set_urbn_defaults(style = "map")
```

### Exercise 0: Create a Project (if you didn't do this last week)

<font color="#55b748">**Step 1:**</font> Create a new directory called `mapping`

<font color="#55b748">**Step 2:**</font> Open RStudio. Click "Project: (None)" in the top right corner. Click "New Project" and create a project based on the existing `mapping` directory.

<font color="#55b748">**Step 3:**</font> Submit `install.packages("tidyverse")` to the Console.

<font color="#55b748">**Step 4:**</font> Submit `install.packages("devtools")` to the Console.

<font color="#55b748">**Step 5:**</font> Submit `remotes::install_github("UrbanInstitute/urbnmapr")` to the Console.

<font color="#55b748">**Step 6:**</font> Submit `remotes::install_github("UrbanInstitute/urbnthemes")` to the Console.

<font color="#55b748">**Step 7:**</font> Write `library(tidyverse)`, `library(urbnmapr)`, and `library(urbnthemes)` at the top of `01_intro-to-mapping.R`. With the cursor on the line of text, click Control-Enter.

### Exercise 0.5: Setup
<font color="#55b748">**Step 1:**</font> Open a `.R` script with the button in the top left. Save the script as `03_spatial_operations.R`.

<font color="#55b748">**Step 2:**</font> Copy and paste the following to the top of `03_spatial_operations.R`. This loads in all the necessary libraries for today. With the cursor highlighting all the below text, click Control-Enter.

```{r lib}
library(tidyverse)
library(urbnmapr)
library(urbnthemes)
library(sf)
library(tigris)
```

### Exercise 1: Mapping Review

<font color="#55b748">**Step 1:**</font> Read in the data for fire stations in DC.

```{r read-fire-stations}
fire_stations <- st_read("https://maps2.dcgis.dc.gov/dcgis/rest/services/DCGIS_DATA/Public_Safety_WebMercator/MapServer/6/query?where=1%3D1&outFields=NAME,ADDRESS,TRUCK,AMBULANCE&outSR=4326&f=geojson")
```

<font color="#55b748">**Step 2:**</font> Use `library(tigris)` to load census tracts for DC. Be sure to use cartographic boundaries!

```{r load-tracts, message = FALSE, warning = FALSE, results = FALSE}

dc_tracts <- tracts(state = "DC",
                    year = 2017,
                    class = "sf",
                    cb = TRUE)

```

<font color="#55b748">**Step 3:**</font> Map the fire stations on top of the DC census tracts. Make the fire stations red!

```{r map-stations}

ggplot() +
  geom_sf(data = dc_tracts, mapping = aes(),
          fill = "grey", color = "black") +
  geom_sf(data = fire_stations, mapping = aes(),
          color = "red")

```

# Spatial Joins

<font color="#ec008b"> Spatial joins </font>

In non-spatial joins, like we demonstrated on day 1, you typically join two datasets on a common identifier. In spatial joins, you are instead joining on location

The important thing to note for spatial joins is that the two spatial datasets that you are joining must be in the same CRS. 

<font color="#55b748">**Step 1:**</font> Check the CRS of the two spatial datasets that we read in.

<font color="#55b748">**Step 2:**</font> Change the CRS of `fire_stations` and `dc_tracts` to EPSG code 6487.

```{r re-project}

dc_tracts <- st_transform(dc_tracts, crs = 6487)

fire_stations <- st_transform(fire_stations, crs = 6487)

```

<font color="#ec008b"> `st_join()` </font>

`st_join()` is the primary function for spatial joins of `sf` objects. The basic syntax is below:

```
joined_data <- st_join(x, y, join = st_intersects())
```
The geometry on the **left** side of the join is the geometry that will be retained. By default, `st_join()` will perform a left join, which means only the geographies on the left hand side will be retained. You can turn this feature off with the `left = FALSE` argument.

<font color="#55b748">**Step 3:**</font> Spatial join the fire stations to the census tract layers.

# Spatial Subsetting (cropping/clipping)

# Creating Buffers

# Calculating Distance

# Geocoding


