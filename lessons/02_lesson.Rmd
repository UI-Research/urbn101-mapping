---
title: "Day 2: Data Import/Export"
author: "Ajjit Narayanan"
date: "`r format(Sys.time(), '%B %d, %Y %H:%M')`"
output:
  html_document:
    number_sections: true
    self_contained: TRUE
    code_folding: hide
    toc: TRUE
    toc_float: TRUE
    css: ../www/web_report.css
    editor_options:
      chunk_output_type: console
---

    
<style>
@import url('https://fonts.googleapis.com/css?family=Lato&display=swap');
</style>

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato" />

![](../www/images/urban-institute-logo.png)


```{r rmarkdown-setup, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(eval = FALSE)
knitr::opts_chunk$set(cache = TRUE)
knitr::opts_chunk$set(fig.height = 3)
knitr::opts_chunk$set(fig.width = 3)
```


# Review 

* Making maps in R is really powerful and easy
* The `sf` package handles point and polygon spatial data
* sf objects are dataframes with an additional geometry column

```{r, warning=F, message=F, eval = T}
library(urbnmapr)
library(urbnthemes)
library(tidyverse)
library(sf)
library(tigris)
set_urbn_defaults(style = "map")
```



# Reading in spatial data

 Out in the wild, spatial data comes in many formats but some of the common ones you will encounter are:

* CSV's with lon/lat columns
* GeoJSON's (.geojson)
* Shapefiles (.shp)

the `sf` package has a function called `st_read()` that makes reading in any of these types of files easy.

<font color="#ec008b"> For GeoJSONs and Shapefiles:</font>

```{r, eval = F}
data <- st_read("path/to/geojson/file.geojson")
data <- st_read("path/to/shp/file.shp")
```

<font color="#ec008b"> For CSV's:</font>

```{r, eval = F}
# You have two options!
# 1- Read in the file using st_read, but maniupulate some GDAL options
data <- st_read("path/to/csv/file.csv",
  options = c("X_POSSIBLE_NAMES=lon", "Y_POSSIBLE_NAMES=lat")
)

# 2- Read in the file as a data frame and convert it to an sf object
data <- read_csv("path/to/csv/file.csv")
data <- st_as_sf(data, coords = c("lon", "lat"))
```
**NOTE: X = Longitude & Y = Latitude.** You will at some point mix these two up, but try to keep them straight.

`st_read` can also accept URL's!

```{r, eval = T}
data <- st_read("https://opendata.arcgis.com/datasets/287eaa2ecbff4d699762bbc6795ffdca_9.geojson")
```

Notice that it  figured out what filetype it was and what kind of spatial data it was.



## Exercise 0: Create a Project

<font color="#55b748">**Step 1:**</font> Create a new directory called `mapping`

<font color="#55b748">**Step 2:**</font> Open RStudio. Click "Project: (None)" in the top right corner. Click "New Project" and create a project based on the existing `mapping` directory.

<font color="#55b748">**Step 3:**</font> Open a `.R` script with the button in the top left. Save the script as `01_intro-to-mapping.R`.

<font color="#55b748">**Step 4:**</font> Submit `install.packages("tidyverse")` to the Console.

<font color="#55b748">**Step 5:**</font> Submit `install.packages("devtools")` to the Console.

<font color="#55b748">**Step 6:**</font> Submit `remotes::install_github("UrbanInstitute/urbnmapr")` to the Console.

<font color="#55b748">**Step 7:**</font> Submit `remotes::install_github("UrbanInstitute/urbnthemes")` to the Console.

<font color="#55b748">**Step 8:**</font> Write `library(tidyverse)`, `library(urbnmapr)`, and `library(urbnthemes)` at the top of `01_intro-to-mapping.R`. With the cursor on the line of text, click Control-Enter.

## Exercise 1: Read in a GeoJSON

<font color="#55b748">**Step 1:**</font> Read in data on the locations of all fire stations in DC. Create a variable named `fire_stations` and using `st_read`, read in the following GeoJSON from this URL: https://maps2.dcgis.dc.gov/dcgis/rest/services/DCGIS_DATA/Public_Safety_WebMercator/MapServer/6/query?where=1%3D1&outFields=NAME,ADDRESS,TRUCK,AMBULANCE&outSR=4326&f=geojson

<font color="#55b748">**Step 2:**</font> Type in `fire_stations` into your console and press enter. What does this SF dataframe look like? F

## Exercise 2: Read in a CSV
<font color="#55b748">**Step 1:**</font> Copy and paste the following link into your browser to download the CSV to you computer. It's a dataset on all crimes in DC within the last 30 days.
https://geocoding-codestar-test.s3.us-east-2.amazonaws.com/crime_last_30_days.csv

<font color="#55b748">**Step 1:**</font> Create a folder called `data` in your mapping101 folder, and move the downloaded CSV into that folder

<font color="#55b748">**Step 2:**</font> Find the filepath to the CSV (it should be something like 'data/example.csv') and read it into R as an sf dataframe named `crime_30`. Note: You may need to open the CSV to see what the X and Y columns are labelled as. You can use any of the two methods described above




# Writing out spatial data 
  
sf has a function called `st_write` that can write out sf objects as GeoJSON's, shapefiles, CSVS, Geopackages, or just about any other spatial format supported by [GDAL](https://gdal.org/drivers/vector/index.html). We recommend  saving your spatial files as GeoJSON's whenever you can for for a few reasons:

  1) It's a pretty universal file format that can easily be read back into R or other programs like ArcGIS, or Python
  2) It uses standardized projections and naming conventions, which saves you a lot of headaches down the road
  3) It's pretty lightweight file format, especially for small to medium sized spatial files
  

<font color="#ec008b"> Writing out GeoJSONs and Shapefiles: </font>

```{r, eval = F}
st_write(sf_data, "output/path/filename.geojson")
st_write(sf_data, "output/path/filename.shp")
```


<font color="#ec008b"> Writing out CSV's </font>

There may be some cases when you need to write out your spatial data as a CSV to share with other folks. sf does let you do that, but the lat/lon columns will either be labelled X/Y or be a single WKT column. 

|X|Y|
|-|-|
|-76.9651|38.89204|


|WKT|
|:--|
|POINT (-76.9651, 38.89204)|

Here's how you write out CSV's both ways using `sf_write`:

```{r, eval = F}
# Writing out X and Y columsn to CSV
st_write(sf_data, "C:/Users/anarayanan/Downloads/exparkslocations.csv",
  layer_options = "GEOMETRY=AS_XY"
)

# Writing out WKT columns to CSV
st_write(sf_data, "C:/Users/anarayanan/Downloads/exparkslocations.csv",
  layer_options = "GEOMETRY=AS_WKT"
)
```

But sometimes, we want to write out CSVs with human readable Latitude and Longitude columns instead of X and Y columns as they are easy to mix up (quick - is X latitiude or longitude?).SF doesn't give you the ability to do this easily. So we need to extract the coordinates from the SF dataframe, append them as columns to our dataframe, then rename them latitide/longitude.

```{r, eval = F}
# getting lon/lat columns from dataframe
coords = st_coordinates(data) %>% 
  as_tibble() %>% 
  dplyr::rename(lon = X, lat = Y)

# appending lon/lat columns to dataframe
data = data %>% 
  st_set_geometry(NULL) %>% 
  bind_cols(coords)

# writing out dataframe as csv
write_csv(data, "path/to/file.csv")
```


## Exercise 4: Writing out Spatial data
<font color="#55b748">**Step 1:**</font> Let's say we were only interested in relatively large fire stations. Use the `filter()` function to limit the `fire_stations` dataframe to stations that have more than 5 trucks (ie `TRUCKS > 5`). Call this filtered dataframe `big_stations`

<font color="#55b748">**Step 2:**</font> Write out the `big_stations` dataframe as a GeoJSON into the `data\` folder we created earlier using `st_write()`. Call the file `big_stations.geojson`.

<font color="#55b748">**Step 3:**</font> Write out the `big_stations` dataframe as a CSV with lat/lon columns into the `data\` folder we created earlier using `st_write()`. Call the file `big_stations.csv`. 




# Where can I find spatial data?

The `tigris` package in R is a great place to start looking. `tigris` provides spatial data for:

* Census Tracts, Blocks, & Block Groups
* Counties, ZCTA's, PUMA's, Places
* congressinal districts, School Districts
* roads, railways, native areas, military bases
* Lots of other data sources!

It provides powerful functionality by allowing you to filter to specific states, counties, or tracts. Say for example I wanted data on all block groups in DC

```{r, fig.width=3, fig.height =3, eval = T, message = F, warning = F}
dc <- tigris::block_groups(
  state = "DC",
  year = 2017,
  class = "sf",
  progress_bar = FALSE
)

ggplot(dc) +
  geom_sf()
```


There's also a sister package called `tidycensus` that provides easy access to census data in addition to spatial data. Say for example you wanted data on the population counts in Montgomery County censust tracts from from the 1 year ACS:

```{r}
# Note you need to sign up for a free Census API key here:
#
api_key = ''
x = get_acs("tract", year = 2016, endyear = 2016, state = "MD", county = "Montgomery", keep_geo_vars = TRUE)

```





Below are some other common places to find spatial data

* [Open Data Portals](https://opendata.dc.gov/)

* [IPUMS NHGIS](https://www.nhgis.org/documentation/gis-data)




## Exercise 5: Using tigris
<font color="#55b748">**Step 1:**</font> Use the `school_districts()` function in tigris to download all the school districts in Oregon from the year 2015. Call the variable `or_school_districts.` Make sure to set `class = "sf"`!

<font color="#55b748">**Step 2:**</font> Use `ggplot()` and `geom_sf()` to make a plot of all the school districts in Oregon


## Exercise 6: What are projections?

<font color="#55b748">**Step 1:**</font> Download the zipped shapefile of Toronto's zoning boundaries from here: ftp://webftp.vancouver.ca/OpenData/shape/zoning_districts_shp.zip

<font color="#55b748">**Step 2:**</font> Unzip the contents of the shapefile into the `data` folder of the `mapping101` directory.

<font color="#55b748">**Step 3:**</font> Find the filepath to the `zoning_districts.shp` file in the `data` folder and read in the shapefile into R. Name the object `tor_zones`.

<font color="#55b748">**Step 3:**</font> Type `tor_zones` into the column and take a look at the geometry column. What's wrong with those points?


# Coordinate Reference Systems

Whenever you create a map you have to make assumptions about 1) the exact 3d shape of the earth and 2) how to project that 3d shape onto a 2d surface. That's where projections or coordinate re


